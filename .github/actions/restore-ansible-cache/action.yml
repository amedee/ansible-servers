---
name: ♻️ Restore Ansible Cache
description: Restores and relocates Ansible role/collection cache

runs:
  using: "composite"
  steps:
    - name: Restore Ansible roles and collections cache
      uses: actions/cache/restore@v4
      with:
        path: |
          .ansible/
          roles/
        key: ansible-deps-${{ hashFiles('requirements.yml') }}

    - name: Pre-install Ansible Galaxy roles (with retry)
      shell: bash
      run: |
        for i in {1..5}; do
          if ansible-galaxy install -vv -r requirements.yml; then
            break
          else
            echo "Installation failed, retry in $((i * 10)) seconds…" >&2
            sleep $((i * 10))
          fi
        done

    - name: Copy Ansible collections to proper directory
      shell: bash
      run: |
        mkdir -p .ansible/collections /home/runner/.ansible
        cp -r .ansible/collections /home/runner/.ansible/
