---
name: 🔔 Check Fine-Grained PAT Expiration

on: # yamllint disable-line rule:truthy
  schedule:
    - cron: "0 7 * * 1" # Every Monday at 07:00 UTC
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  issues: write

jobs:
  check-token-expiration:
    runs-on: ubuntu-latest
    steps:
      - name: Check PAT expiration via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          TOKEN_NAME="GH_FINEGRAINED_PAT"
          ALERT_DAYS=14
          # Simulate expiration tracking with a static date
          # Replace this with a manual update each time you create a new token
          # Format: YYYY-MM-DD
          TOKEN_EXPIRY="2025-09-16"

          TODAY=$(date +%s)
          EXPIRY_DATE=$(date -d "$TOKEN_EXPIRY" +%s)
          DAYS_LEFT=$(( (EXPIRY_DATE - TODAY) / 86400 ))

          # Human-friendly messages
          if [ "$DAYS_LEFT" -lt 0 ]; then
            DAYS_AGO=$(( -DAYS_LEFT ))
            ALERT_MESSAGE="⚠️ Token has expired $DAYS_AGO day(s) ago!"
            COMMENT_SUFFIX="expired $DAYS_AGO day(s) ago"
          elif [ "$DAYS_LEFT" -eq 0 ]; then
            ALERT_MESSAGE="⚠️ Token expires today!"
            COMMENT_SUFFIX="expires today"
          else
            ALERT_MESSAGE="⚠️ Token will expire in $DAYS_LEFT day(s)!"
            COMMENT_SUFFIX="will expire in **$DAYS_LEFT** day(s)"
          fi

          TITLE="⚠️ Fine-Grained PAT '$TOKEN_NAME' Expiring Soon"
          echo "$ALERT_MESSAGE"

          # Find all open issues with the same title
          ISSUE_NUMBERS=$(gh issue list \
            --repo "$REPO" \
            --state open \
            --json number,title \
            --jq ".[] | select(.title==\"$TITLE\") | .number")

          # Sort numerically and pick the lowest number as main
          MAIN_ISSUE=$(echo "$ISSUE_NUMBERS" | sort -n | head -n1)
          DUPLICATES=$(echo "$ISSUE_NUMBERS" | sort -n | tail -n +2)

          if [ "$DAYS_LEFT" -le "$ALERT_DAYS" ]; then
            # Token is expiring or expired
            if [ -n "$MAIN_ISSUE" ]; then
              echo "Adding comment to main issue #$MAIN_ISSUE"
              gh issue comment "$MAIN_ISSUE" \
                --repo "$REPO" \
                --body "🔔 Reminder: Token \`$TOKEN_NAME\` $COMMENT_SUFFIX."

              # Close duplicates
              for ISSUE in $DUPLICATES; do
                echo "Closing duplicate issue #$ISSUE"
                gh issue comment "$ISSUE" \
                  --repo "$REPO" \
                  --body "🔁 This issue duplicates #$MAIN_ISSUE. Closing it."
                gh issue close "$ISSUE" --repo "$REPO"
              done
            else
              echo "No existing issue found. Creating a new one."
              gh issue create \
                --repo "$REPO" \
                --title "$TITLE" \
                --body "Your token \`$TOKEN_NAME\` $COMMENT_SUFFIX. Please generate a new one." \
                --label "maintenance"
            fi
          else
            # Token is still valid
            echo "Token is valid (not expiring soon)."

            for ISSUE in $ISSUE_NUMBERS; do
              echo "Closing issue #$ISSUE because the token is valid again."
              gh issue comment "$ISSUE" \
                --repo "$REPO" \
                --body "✅ Token \`$TOKEN_NAME\` has been renewed (now **$DAYS_LEFT** day(s) left). Closing this issue."
              gh issue close "$ISSUE" --repo "$REPO"
            done
          fi

          # GitHub Step Summary
          {
            echo "### 🧪 PAT Expiration Check"
            echo "- Token name: \`$TOKEN_NAME\`"
            if [ "$DAYS_LEFT" -lt 0 ]; then
              echo "- ❌ Token expired $DAYS_AGO day(s) ago."
            elif [ "$DAYS_LEFT" -eq 0 ]; then
              echo "- ⚠️ Token expires today!"
            else
              echo "- Days until expiration: **$DAYS_LEFT**"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
