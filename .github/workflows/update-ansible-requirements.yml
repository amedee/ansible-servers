---
name: ⬆️ Update Ansible Requirements

on: # yamllint disable-line rule:truthy
  schedule:
    - cron: '0 5 * * 1'  # Every Monday at 05:00 UTC
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  update-ansible-deps:
    runs-on: ubuntu-latest
    steps:
      - name: ⤵️ Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: 🐍 Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: '3.13'

      - name: 📦 Install Dependencies
        run: |
          pip install ruamel.yaml requests packaging

      - name: 🔄 Update requirements.yml
        run: python .github/scripts/update_ansible_requirements.py

      - name: Check if requirements.yml changed (staged)
        id: changes
        run: |
          git add requirements.yml
          git diff --cached --word-diff
          if git diff --cached --quiet; then
            echo "no_changes=true"
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "no_changes=false"
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Generate AI commit message
        id: ai_commit
        uses: ./.github/actions/ai-commit-message
        if: steps.changes.outputs.no_changes == 'false'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          diff_path: 'requirements.yml'
          prompt_content: |
            Write a concise Git commit message describing the staged updates
            to Ansible roles and collections in requirements.yml.
            The commit message must start with a relevant emoji on the first line,
            which is max 72 characters.
            Leave a blank line after the first line.
            Then add the rest of the commit message explaining the changes.

      - name: Show message
        if: steps.changes.outputs.no_changes == 'false'
        run: |
          echo "Message from AI: ${{ steps.ai_commit.outputs.message }}"

      - name: 🧪 Commit & Push updated requirements.yml
        id: commit_push
        if: steps.changes.outputs.no_changes == 'false'
        env:
          ANSIBLE_DEP_UPDATER_TOKEN: ${{ secrets.ANSIBLE_DEP_UPDATER_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -b ansible-requirements-update
          git add requirements.yml
          if [ "${{ steps.changes.outputs.no_changes }}" = "false" ]; then
            raw_message="${{ steps.ai_commit.outputs.message }}"
            message="${raw_message//\`/}"  # Remove backticks if needed
            # Split first line and rest for the requirements.yml style commit message
            first_line=$(echo "$message" | head -n1 | cut -c1-72)
            rest=$(echo "$message" | tail -n +2)
            full_message="$first_line"$'\n\n'"$rest"
            git commit -m "$full_message"
            REPO_URL="https://x-access-token:${ANSIBLE_DEP_UPDATER_TOKEN}@github.com/${{ github.repository }}.git"
            git push --force "$REPO_URL" ansible-requirements-update
            git fetch origin ansible-requirements-update:refs/remotes/origin/ansible-requirements-update
            echo "pushed=true" >> "$GITHUB_OUTPUT"
          else
            echo "No changes to commit."
            echo "pushed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: 🔁 Create PR
        if: steps.commit_push.outputs.pushed == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          base: ${{ github.event.repository.default_branch }}
          branch: ansible-requirements-update
          title: '⬆️ Update Ansible requirements'
          body: 'This PR updates the versions in `requirements.yml` to their latest available versions.'
          delete-branch: true
