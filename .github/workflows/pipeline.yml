---
name: ğŸ§ªğŸ§¼ğŸš€ Wash, Test, Deploy

on: # yamllint disable-line rule:truthy
  push:
    branches:
      - main
    paths:
      - "**"
      - "!*.md"
      - "!.pre-commit-config.yaml"
      - "!Vagrantfile"
      - "!deploy_to_staging.sh"
      - "!resize_disk.sh"
  schedule:
    - cron: "10 3 * * SAT"
  workflow_dispatch:

concurrency:
  group: pipeline-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  actions: read
  contents: write
  id-token: write
  issues: write
  packages: read
  pull-requests: write
  security-events: write
  statuses: write

jobs:
  ansible-cache:
    name: ğŸš€ Ansible Cache
    uses: ./.github/workflows/ansible-cache.yml

  codacy:
    name: ğŸ› ï¸ Code Quality â€” Codacy Scan
    uses: ./.github/workflows/code-quality-codacy.yml

  super-linter:
    name: ğŸ› ï¸ Code Quality â€” Super-Linter
    uses: ./.github/workflows/code-quality-super-linter.yml
    needs:
      - ansible-cache

  ansible-lint:
    name: ğŸ› ï¸ Code Quality â€” Ansible Lint
    uses: ./.github/workflows/code-quality-ansible-lint.yml
    needs:
      - ansible-cache

  validate-configs:
    name: ğŸ› ï¸ Code Quality â€” Validate Configs
    uses: ./.github/workflows/code-quality-validate-configs.yml

  dry-run:
    name: ğŸ” Dry Run on Production
    uses: ./.github/workflows/ansible-run.yml
    needs:
      - ansible-cache
    with:
      check-mode: true
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      VAULT_PASSWORD: ${{ secrets.VAULT_PASSWORD }}

  deploy:
    name: ğŸš€ Deploy to Production
    uses: ./.github/workflows/ansible-run.yml
    needs:
      - ansible-cache
      - codacy
      - dry-run
      - super-linter
      - ansible-lint
      - validate-configs
    with:
      check-mode: false
    secrets:
      SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
      VAULT_PASSWORD: ${{ secrets.VAULT_PASSWORD }}

  ansible-doctor:
    name: ğŸ“š Ansible Role Docs
    uses: ./.github/workflows/ansible-doctor.yml
    needs: deploy
    secrets:
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}

  gource:
    name: ğŸ“½ï¸ Gource
    uses: ./.github/workflows/gource.yml
    needs: deploy
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  workflow-metrics:
    name: ğŸ“Š Workflow Metrics
    uses: ./.github/workflows/workflow-metrics.yml
    needs: deploy

  cleanup-gource:
    name: ğŸ§¹ Cleanup orphaned Gource files
    uses: ./.github/workflows/cleanup-gource.yml
    needs: gource
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
