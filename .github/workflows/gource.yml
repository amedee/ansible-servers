---
name: Gource
on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  gource:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if gource.yml was changed
        id: gource-changed
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q '^\.github/workflows/gource\.yml$'; then
            echo "gource_yml_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "gource_yml_changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check last successful run time
        id: last-run
        run: |
          # Get the raw JSON of the latest runs
          LAST_RUN_JSON=$(gh run list \
            --limit 5 \
            --workflow "${{ github.workflow }}" \
            --branch main \
            --json status,conclusion,createdAt \
            --jq '.')

          # Extract the last successful run's timestamp
          # yamllint disable-line rule:line-length
          LAST_RUN=$(echo "$LAST_RUN_JSON" | jq -r '[.[] | select(.status == "completed" and .conclusion == "success")] | .[0].createdAt')

          echo "Last successful run: $LAST_RUN"

          if [ -z "$LAST_RUN" ]; then
            echo "No previous successful run found."
            echo "run_job=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TS=$(date --date="$LAST_RUN" +%s)
          NOW_TS=$(date +%s)
          (( DIFF=NOW_TS-LAST_TS ))
          echo "Time difference in seconds: $DIFF"

          if [ "$DIFF" -gt $((60*60*24)) ]; then
            echo "More than 1 day ago."
            echo "run_job=true" >> "$GITHUB_OUTPUT"
          else
            echo "Less than 1 day ago."
            echo "run_job=false" >> "$GITHUB_OUTPUT"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Set skip flag if job should be skipped
        id: skip-check
        run: |
          if [ "${{ steps.last-run.outputs.run_job }}" == "false" ] && \
             [ "${{ steps.gource-changed.outputs.gource_yml_changed }}" == "false" ]; then
            echo "Skipping run: less than 1 week and gource.yml unchanged."
            echo "skip_job=true" >> "$GITHUB_OUTPUT"
            exit 78
          fi

          echo "skip_job=false" >> "$GITHUB_OUTPUT"

      - name: Make a video of the repository history
        if: ${{ steps.skip-check.outputs.skip_job != 'true' }}
        uses: nbprojekt/gource-action@57256d303c5a9a5e72ed92ba13e3e83c5ec8b257 # v1.3.0
        with:
          avatars_auto_fetch: true
          gource_auto_skip_seconds: 1
          gource_seconds_per_day: 0.3
          gource_title: Ansible Servers â€“ Evolution

      - name: Prepare and upload gource video and thumbnail to S3
        id: gource-upload
        if: ${{ steps.skip-check.outputs.skip_job != 'true' }}
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
        run: |
          set -e

          COMMIT_HASH=$(git rev-parse --short HEAD)
          ORIG_VIDEO=./gource/gource.mp4
          VIDEO=./gource/gource-$COMMIT_HASH.mp4
          THUMB=./gource/gource-$COMMIT_HASH.gif

          mv "$ORIG_VIDEO" "$VIDEO"

          echo "Generating thumbnail..."
          sudo apt-get update && sudo apt-get install -y ffmpeg
          ffmpeg -y -i "$VIDEO" \
            -filter_complex "[0:v]select='not(mod(n,60))',setpts=0.1*PTS,fps=10,scale=320:-1:flags=lanczos" \
            -vsync vfr "$THUMB"

          BUCKET=gource-by-amedee
          REGION=us-east-1
          KEY_BASE=gource-$COMMIT_HASH
          VIDEO_KEY=$KEY_BASE.mp4
          THUMB_KEY=$KEY_BASE.gif

          echo "Uploading video..."
          aws s3 cp "$VIDEO" "s3://$BUCKET/$VIDEO_KEY" \
            --content-type video/mp4
          aws s3api copy-object \
            --bucket "$BUCKET" \
            --copy-source "$BUCKET/$VIDEO_KEY" \
            --key gource-latest.mp4 \
            --content-type video/mp4

          echo "Uploading thumbnail..."
          aws s3 cp "$THUMB" "s3://$BUCKET/$THUMB_KEY" \
            --content-type image/gif
          aws s3api copy-object \
            --bucket "$BUCKET" \
            --copy-source "$BUCKET/$THUMB_KEY" \
            --key gource-latest.gif \
            --content-type image/gif

          VIDEO_URL="https://$BUCKET.s3.$REGION.amazonaws.com/$VIDEO_KEY"
          THUMB_URL="https://$BUCKET.s3.$REGION.amazonaws.com/$THUMB_KEY"

          FILE_SIZE=$(du -h "$VIDEO" | cut -f1)
          COMMIT_MSG=$(git log -1 --pretty=%s)

          {
            echo "### ðŸ“½ï¸ Gource Video Upload Summary"
            echo ""
            echo "![Preview]($THUMB_URL)"
            echo ""
            echo "- **Public URL:** [Click to view video]($VIDEO_URL)"
            echo "- **File size:** $FILE_SIZE"
            echo "- **Commit:** \`$COMMIT_HASH\` â€“ $COMMIT_MSG"
          } >> "$GITHUB_STEP_SUMMARY"
