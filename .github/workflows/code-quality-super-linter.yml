---
name: üõ†Ô∏è Code Quality ‚Äî Super-Linter

on: # yamllint disable-line rule:truthy
  pull_request:
    types:
      - opened
      - ready_for_review
      - reopened
      - synchronize
  workflow_call:
    secrets:
      OPENROUTER_API_KEY:
        required: true
      ANSIBLE_DEP_UPDATER_TOKEN:
        required: true
  workflow_dispatch:

concurrency:
  group: ${{ format(
    'code-quality-super-linter-{0}-{1}',
    github.workflow,
    github.event_name == 'pull_request' && github.head_ref || github.ref) }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lint:
    name: Super-linter
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      statuses: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # super-linter needs the full git history to get the
          # list of files that changed across commits
          fetch-depth: 0
          persist-credentials: false

      - name: Restore Ansible cache
        uses: ./.github/actions/restore-ansible-cache

      - name: Run Super-linter
        id: super-linter
        # yamllint disable-line rule:line-length
        uses: super-linter/super-linter/slim@d5b0a2ab116623730dd094f15ddc1b6b25bf7b99 # v8.3.2
        env:
          CREATE_LOG_FILE: true
          FAIL_ON_CONFLICTING_TOOLS_ENABLED: true
          FIX_BIOME_FORMAT: true
          FIX_BIOME_LINT: true
          FIX_GITHUB_ACTIONS_ZIZMOR: true
          FIX_JSON_PRETTIER: false
          FIX_PYTHON_RUFF_FORMAT: true
          FIX_SHELL_SHFMT: true
          FIX_YAML_PRETTIER: false
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          IGNORE_GITIGNORED_FILES: true
          LINTER_RULES_PATH: "."
          VALIDATE_ANSIBLE: false
          VALIDATE_CLANG_FORMAT: false
          VALIDATE_CLOJURE: false
          VALIDATE_CLOUDFORMATION: false
          VALIDATE_COFFEESCRIPT: false
          VALIDATE_CPP: false
          VALIDATE_CSS: false
          VALIDATE_CSS_PRETTIER: false
          VALIDATE_CSS_STYLELINT: false
          VALIDATE_DART: false
          VALIDATE_DOCKERFILE_HADOLINT: false
          VALIDATE_EDITORCONFIG: false
          VALIDATE_ENV: false
          VALIDATE_GIT_COMMITLINT: false
          VALIDATE_GO: false
          VALIDATE_GOOGLE_JAVA_FORMAT: false
          VALIDATE_GO_MODULES: false
          VALIDATE_GO_RELEASER: false
          VALIDATE_GRAPHQL_PRETTIER: false
          VALIDATE_GROOVY: false
          VALIDATE_HTML: false
          VALIDATE_HTML_PRETTIER: false
          VALIDATE_JAVA: false
          VALIDATE_JAVASCRIPT_ES: false
          VALIDATE_JAVASCRIPT_PRETTIER: false
          VALIDATE_JSON: false
          VALIDATE_JSONC: false
          VALIDATE_JSONC_PRETTIER: false
          VALIDATE_JSON_PRETTIER: false
          VALIDATE_JSX: false
          VALIDATE_JSX_PRETTIER: false
          VALIDATE_JUPYTER_NBQA_BLACK: false
          VALIDATE_JUPYTER_NBQA_FLAKE8: false
          VALIDATE_JUPYTER_NBQA_ISORT: false
          VALIDATE_JUPYTER_NBQA_MYPY: false
          VALIDATE_JUPYTER_NBQA_PYLINT: false
          VALIDATE_JUPYTER_NBQA_RUFF: false
          VALIDATE_KOTLIN: false
          VALIDATE_KUBERNETES_KUBECONFORM: false
          VALIDATE_LATEX: false
          VALIDATE_LUA: false
          VALIDATE_NATURAL_LANGUAGE: false
          VALIDATE_OPENAPI: false
          VALIDATE_PERL: false
          VALIDATE_PHP_BUILTIN: false
          VALIDATE_PHP_PHPCS: false
          VALIDATE_PHP_PHPSTAN: false
          VALIDATE_PHP_PSALM: false
          VALIDATE_PRE_COMMIT: false
          VALIDATE_PROTOBUF: false
          VALIDATE_PYTHON: false
          VALIDATE_PYTHON_BLACK: false
          VALIDATE_PYTHON_PYLINT: false
          VALIDATE_R: false
          VALIDATE_RENOVATE: false
          VALIDATE_RUBY: false
          VALIDATE_SCALAFMT: false
          VALIDATE_SNAKEMAKE_LINT: false
          VALIDATE_SNAKEMAKE_SNAKEFMT: false
          VALIDATE_SQLFLUFF: false
          VALIDATE_STATES: false
          VALIDATE_TERRAFORM_FMT: false
          VALIDATE_TERRAFORM_TERRASCAN: false
          VALIDATE_TERRAFORM_TFLINT: false
          VALIDATE_TERRAGRUNT: false
          VALIDATE_TSX: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_TYPESCRIPT_PRETTIER: false
          VALIDATE_VUE: false
          VALIDATE_VUE_PRETTIER: false
          VALIDATE_XML: false
          VALIDATE_YAML_PRETTIER: false
          YAML_CONFIG_FILE: ".yamllint.yml"
        continue-on-error: true

      - name: Check if there are changes
        id: changes
        run: |
          # Detect any changes in working tree
          if git diff --ignore-all-space --exit-code --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: üì§ Extract staged git diff
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git diff --ignore-all-space > diff.txt

      - name: üß† Prepare diff outputs
        id: diff_outputs
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          if [ -s diff.txt ]; then
            echo "has_diff=true" >> "$GITHUB_OUTPUT"
            printf "diff_content<<EOF\n%s\nEOF\n" "$(cat diff.txt)" >> "$GITHUB_OUTPUT"
          else
            echo "has_diff=false" >> "$GITHUB_OUTPUT"
            echo "diff_content=" >> "$GITHUB_OUTPUT"
          fi

      - name: Attach diff to summary
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          {
            echo "### üîç Diff"
            echo
            echo '```diff'
            if [ -s diff.txt ]; then
              cat diff.txt
            else
              echo "# No diff file"
            fi
            echo '```'
          } | tee -a "$GITHUB_STEP_SUMMARY"

      - name: ü§ñ Generate AI commit message
        if: ${{ steps.changes.outputs.has_changes == 'true' &&
                github.event_name != 'pull_request' }}
        id: ai_commit
        uses: ./.github/actions/ai-commit-message
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        with:
          diff_content: ${{ steps.diff_outputs.outputs.diff_content }}
          prompt_content: |
            Write a concise Git commit message describing the staged changes.

      - name: Ensure commit message exists
        if: ${{ steps.changes.outputs.has_changes == 'true' &&
                github.event_name != 'pull_request' }}
        env:
          AI_MESSAGE: ${{ steps.ai_commit.outputs.message }}
        run: |
          if [ -z "$AI_MESSAGE" ]; then
            echo "AI commit message missing. Aborting workflow."
            exit 1
          fi

      - name: üîÅ Commit, push, and PR
        if: ${{ steps.changes.outputs.has_changes == 'true' &&
                github.event_name != 'pull_request' }}
        uses: ./.github/actions/create-or-update-pr
        with:
          branch: chore/super-linter
          commit_message: ${{ steps.ai_commit.outputs.message }}
          pr_title: "‚¨ÜÔ∏è Super-Linter"
          pr_body: |
            ## ü§ñ Automated Super-Linter Fixes

            ${{ steps.ai_commit.outputs.message }}

            ---
            **Diff included in workflow summary.**
          github_token: ${{ secrets.ANSIBLE_DEP_UPDATER_TOKEN }}
          git_user_name: "github-actions[bot]"
          git_user_email: "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Fail workflow if super-linter failed
        env:
          STEPS_SUPER_LINTER_OUTCOME: ${{ steps.super-linter.outcome }}
        run: |
          if [ "${STEPS_SUPER_LINTER_OUTCOME}" != "success" ]; then
            echo "Super-Linter failed, failing workflow."
            exit 1
          fi
