---
- name: Check if APT lock files exist
  ansible.builtin.stat:
    path: "{{ item }}"
  loop:
    - /var/lib/apt/lists/lock
    - /var/lib/dpkg/lock
    - /var/lib/dpkg/lock-frontend
  register: lock_files_stat

- name: Wait for APT lock files to be released
  ansible.builtin.shell: |
    ! lsof "{{ item }}"
  loop: >
    {{
      lock_files_stat.results |
      selectattr('stat.exists', 'equalto', true) |
      map(attribute='stat.path') |
      list
    }}
  register: result
  changed_when: false
  until: result.rc == 0
  retries: 300
  delay: 1
  failed_when: result.rc != 0

- name: Print which lock files are still in use (if any)
  ansible.builtin.debug:
    msg: "Lock file still in use: {{ item.item }}"
  loop: >
    {{
      result.results |
      selectattr('rc', '!=', 0) |
      list
    }}
  when: result is failed

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 86400 # One day
  register: result
  retries: 3
  delay: 60
  until: result is not failed

- name: Gather installed package facts
  ansible.builtin.package_facts:
    manager: auto

- name: Hold all "grub-" packages (only in staging)
  ansible.builtin.command: "apt-mark hold {{ item }}"
  # yamllint disable-line rule:line-length
  with_items: "{{ ansible_facts.packages.keys() | select('match', '^grub-') | list }}"
  when:
    - hold_grub_packages | default(false)
    - item in ansible_facts.packages
    - "'hold' not in ansible_facts.packages[item]"
  changed_when: true

- name: Remove unneeded APT packages
  ansible.builtin.apt:
    state: absent
    pkg: "{{ apt_packages_uninstall }}"
  notify:
    - APT autoclean
    - APT autoremove
    - Check if reboot required

- name: Install APT packages
  ansible.builtin.apt:
    state: present
    pkg: "{{ apt_packages }}"
  notify:
    - APT autoclean
    - APT autoremove
    - Check if reboot required

- name: Upgrade all packages
  ansible.builtin.apt:
    upgrade: dist
  notify:
    - APT autoclean
    - APT autoremove
    - Check if reboot required

- name: Install snap packages
  community.general.snap:
    name: "{{ snap_packages }}"
