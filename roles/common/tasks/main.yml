---
- name: Install and upgrade software
  become: true
  block:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600
      register: result
      retries: 3
      delay: 60
      until: result is not failed

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: dist
        autoclean: true
        autoremove: true
      notify:
        - APT autoclean
        - APT autoremove
        - Check if reboot required

    - name: Install APT packages
      ansible.builtin.apt:
        state: present
        pkg: "{{ common_apt_packages }}"
      notify: Check if reboot required

    - name: Install snap packages
      community.general.snap:
        name: "{{ common_snap_packages }}"

- name: Set hostname
  ansible.builtin.hostname:
    name: "{{ hostname }}"

- name: Get my public IP
  community.general.ipify_facts:
  register: my_ip_address

- name: Configure Munin
  when: my_ip_address != "142.93.227.16"
  become: true
  block:
    - name: Add mailinabox IP address to munin-node.conf
      ansible.builtin.lineinfile:
        path: /etc/munin/munin-node.conf
        line: allow ^142\.93\.227\.16$
        insertafter: "^allow .*"
        owner: root
        mode: u=rw,go=r
      notify: Restart munin-node

    - name: Allow access to port 4949
      community.general.ufw:
        rule: allow
        port: 4949
        src: 142.93.227.16
      notify: Restart munin-node

    - name: Exclude loop devices from Munin df and diskstats plugin
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: /etc/munin/plugin-conf.d/
        owner: root
        mode: u=rw,go=r
      with_fileglob: "etc/munin/plugin-conf.d/zzz_*"
      notify: Restart munin-node

- name: Hardlink specified directories using hadori
  become: true
  block:
    - name: Ensure hadori is installed
      ansible.builtin.package:
        name: hadori
        state: present

    - name: Copy monthly cron job for hadori
      ansible.builtin.copy:
        src: etc/cron.monthly/hadori
        dest: /etc/cron.monthly/hadori
        owner: root
        mode: u=rwx,go=r
